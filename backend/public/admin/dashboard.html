<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - VivaCidade Brasil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #f0f4f8;
        }
        .sidebar {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
        }
        .nav-item {
            transition: all 0.3s ease;
        }
        .nav-item:hover {
            transform: translateX(4px);
            background: rgba(0, 102, 255, 0.1);
        }
        .nav-item.active {
            background: linear-gradient(135deg, #0066FF 0%, #00B4A0 100%);
            border-left: 4px solid white;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }
        .stat-number {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, #0066FF 0%, #00B4A0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background: #f8f9fa;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e9ecef;
        }
        td {
            padding: 16px;
            border-bottom: 1px solid #e9ecef;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #0066FF 0%, #00B4A0 100%);
            color: white;
        }
        .btn-primary:hover {
            opacity: 0.9;
        }
        .btn-danger {
            background: #ff4757;
            color: white;
        }
        .btn-danger:hover {
            background: #ff3838;
        }
        .btn-edit {
            background: #f39c12;
            color: white;
        }
        .btn-edit:hover {
            background: #e67e22;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            width: 90%;
            max-width: 500px;
            margin: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-family: inherit;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #0066FF;
            box-shadow: 0 0 0 3px rgba(0,102,255,0.1);
        }
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-64 text-white p-6">
            <div class="flex items-center mb-8">
                <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-teal-500 rounded-lg flex items-center justify-center font-bold text-white mr-3">VC</div>
                <div>
                    <h1 class="text-xl font-bold">VivaCidade</h1>
                    <p class="text-xs text-gray-400">Painel Admin</p>
                </div>
            </div>

            <hr class="border-gray-600 mb-6">

            <nav class="space-y-2">
                <div class="nav-item active px-4 py-3 rounded-lg cursor-pointer flex items-center" onclick="switchSection('dashboard')">
                    <span class="text-xl mr-3">ğŸ“Š</span>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item px-4 py-3 rounded-lg cursor-pointer flex items-center" onclick="switchSection('businesses')">
                    <span class="text-xl mr-3">ğŸª</span>
                    <span>NegÃ³cios</span>
                </div>
                <div class="nav-item px-4 py-3 rounded-lg cursor-pointer flex items-center" onclick="switchSection('users')">
                    <span class="text-xl mr-3">ğŸ‘¥</span>
                    <span>UsuÃ¡rios</span>
                </div>
                <div class="nav-item px-4 py-3 rounded-lg cursor-pointer flex items-center" onclick="switchSection('reviews')">
                    <span class="text-xl mr-3">â­</span>
                    <span>AvaliaÃ§Ãµes</span>
                </div>
                <div class="nav-item px-4 py-3 rounded-lg cursor-pointer flex items-center" onclick="switchSection('events')">
                    <span class="text-xl mr-3">ğŸ“…</span>
                    <span>Eventos</span>
                </div>
                <div class="nav-item px-4 py-3 rounded-lg cursor-pointer flex items-center" onclick="switchSection('seals')">
                    <span class="text-xl mr-3">âœ¨</span>
                    <span>Selos</span>
                </div>
                <div class="nav-item px-4 py-3 rounded-lg cursor-pointer flex items-center" onclick="switchSection('coupons')">
                    <span class="text-xl mr-3">ğŸŸï¸</span>
                    <span>Cupons</span>
                </div>
            </nav>

            <hr class="border-gray-600 my-6">

            <a href="/analytics.html" target="_blank" class="w-full px-4 py-3 rounded-lg bg-purple-500 hover:bg-purple-600 flex items-center justify-center text-white font-600 transition mb-2">
                <span class="mr-2">ğŸ“Š</span>
                Analytics
            </a>

            <button onclick="logout()" class="w-full px-4 py-3 rounded-lg bg-red-500 hover:bg-red-600 flex items-center justify-center text-white font-600 transition">
                <span class="mr-2">ğŸšª</span>
                Sair
            </button>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-auto">
            <div class="p-8">
                <!-- Header -->
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800">Painel de AdministraÃ§Ã£o</h2>
                    <div id="admin-user" class="text-right">
                        <p class="text-gray-600 font-600">Carregando...</p>
                    </div>
                </div>

                <!-- DASHBOARD SECTION -->
                <div id="dashboard" class="section active">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card">
                            <p class="text-gray-600 text-sm mb-2">Total de NegÃ³cios</p>
                            <div class="stat-number" id="total-businesses">0</div>
                        </div>
                        <div class="stat-card">
                            <p class="text-gray-600 text-sm mb-2">Total de UsuÃ¡rios</p>
                            <div class="stat-number" id="total-users">0</div>
                        </div>
                        <div class="stat-card">
                            <p class="text-gray-600 text-sm mb-2">Total de AvaliaÃ§Ãµes</p>
                            <div class="stat-number" id="total-reviews">0</div>
                        </div>
                        <div class="stat-card">
                            <p class="text-gray-600 text-sm mb-2">Total de Eventos</p>
                            <div class="stat-number" id="total-events">0</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="chart-container">
                            <h3 class="text-lg font-bold mb-4 text-gray-800">ğŸ“Š DistribuiÃ§Ã£o por Categoria</h3>
                            <canvas id="categoriesChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 class="text-lg font-bold mb-4 text-gray-800">ğŸ™ï¸ NegÃ³cios por Cidade</h3>
                            <canvas id="citiesChart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-8 shadow-lg">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">âœ… Status do Sistema</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                                <p class="font-600 text-green-800">âœ… Backend: Online</p>
                                <p class="text-sm text-gray-600">vivacidade-brasil-api.onrender.com</p>
                            </div>
                            <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                                <p class="font-600 text-green-800">âœ… Frontend: Online</p>
                                <p class="text-sm text-gray-600">vivacidade-brasil-web.onrender.com</p>
                            </div>
                            <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                                <p class="font-600 text-green-800">âœ… MongoDB: Conectado</p>
                                <p class="text-sm text-gray-600">Atlas cluster0</p>
                            </div>
                            <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                                <p class="font-600 text-green-800">âœ… Cloudinary: Ativo</p>
                                <p class="text-sm text-gray-600">Upload de imagens funcional</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BUSINESSES SECTION -->
                <div id="businesses" class="section">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Gerenciar NegÃ³cios</h3>
                        <button onclick="openBusinessModal()" class="btn btn-primary">
                            â• Novo NegÃ³cio
                        </button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Categoria</th>
                                    <th>Cidade</th>
                                    <th>ProprietÃ¡rio</th>
                                    <th>AÃ§Ãµes</th>
                                </tr>
                            </thead>
                            <tbody id="businesses-table">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-500">Carregando negÃ³cios...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- USERS SECTION -->
                <div id="users" class="section">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">Gerenciar UsuÃ¡rios</h3>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Tipo</th>
                                    <th>Data de Cadastro</th>
                                    <th>AÃ§Ãµes</th>
                                </tr>
                            </thead>
                            <tbody id="users-table">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-500">Carregando usuÃ¡rios...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- REVIEWS SECTION -->
                <div id="reviews" class="section">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">Gerenciar AvaliaÃ§Ãµes</h3>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>NegÃ³cio</th>
                                    <th>Avaliador</th>
                                    <th>Nota</th>
                                    <th>ComentÃ¡rio</th>
                                    <th>Data</th>
                                    <th>AÃ§Ãµes</th>
                                </tr>
                            </thead>
                            <tbody id="reviews-table">
                                <tr>
                                    <td colspan="6" class="text-center py-8 text-gray-500">Carregando avaliaÃ§Ãµes...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- EVENTS SECTION -->
                <div id="events" class="section">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Gerenciar Eventos</h3>
                        <button onclick="openEventModal()" class="btn btn-primary">
                            â• Novo Evento
                        </button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>NegÃ³cio</th>
                                    <th>Data</th>
                                    <th>Local</th>
                                    <th>AÃ§Ãµes</th>
                                </tr>
                            </thead>
                            <tbody id="events-table">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-500">Carregando eventos...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Seals Section -->
                <div id="seals" class="section">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Gerenciar Selos</h3>
                        <button onclick="openSealModal()" class="btn btn-primary">
                            âœ¨ Adicionar Selo
                        </button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>NegÃ³cio</th>
                                    <th>Selos</th>
                                    <th>Rating</th>
                                    <th>Reviews</th>
                                    <th>AÃ§Ãµes</th>
                                </tr>
                            </thead>
                            <tbody id="seals-table">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-500">Carregando selos...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Coupons Section -->
                <div id="coupons" class="section">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Gerenciar Cupons</h3>
                        <button onclick="openCouponModal()" class="btn btn-primary">
                            ğŸŸï¸ Novo Cupom
                        </button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>CÃ³digo</th>
                                    <th>NegÃ³cio</th>
                                    <th>Desconto</th>
                                    <th>Usos</th>
                                    <th>Validade</th>
                                    <th>Status</th>
                                    <th>AÃ§Ãµes</th>
                                </tr>
                            </thead>
                            <tbody id="coupons-table">
                                <tr>
                                    <td colspan="7" class="text-center py-8 text-gray-500">Carregando cupons...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Business Modal -->
    <div id="businessModal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <h2 class="text-2xl font-bold mb-6" id="business-modal-title">Novo NegÃ³cio</h2>
            <div class="form-group">
                <label>Nome</label>
                <input type="text" id="business-name" placeholder="Nome do negÃ³cio">
            </div>
            <div class="form-group">
                <label>DescriÃ§Ã£o</label>
                <textarea id="business-desc" rows="3" placeholder="DescriÃ§Ã£o do negÃ³cio..."></textarea>
            </div>
            <div class="form-group">
                <label>Categoria</label>
                <select id="business-category" required>
                    <option value="">-- Selecione uma categoria --</option>
                    <option value="Restaurante">ğŸ½ï¸ Restaurante</option>
                    <option value="CafÃ©">â˜• CafÃ©</option>
                    <option value="Bar">ğŸ¸ Bar</option>
                    <option value="Pizzaria">ğŸ• Pizzaria</option>
                    <option value="Sorveteria">ğŸ¦ Sorveteria</option>
                    <option value="Padaria">ğŸ¥ Padaria</option>
                    <option value="Churrascaria">ğŸ– Churrascaria</option>
                    <option value="Lanchonete">ğŸ” Lanchonete</option>
                    <option value="Hotel">ğŸ¨ Hotel</option>
                    <option value="Pousada">ğŸ© Pousada</option>
                    <option value="Hostel">ğŸ›ï¸ Hostel</option>
                    <option value="Aluguel de Temporada">ğŸ  Aluguel de Temporada</option>
                    <option value="AgÃªncia de Turismo">âœˆï¸ AgÃªncia de Turismo</option>
                    <option value="Passeios e Tours">ğŸšŒ Passeios e Tours</option>
                    <option value="Trilhas e Ecoturismo">ğŸ¥¾ Trilhas e Ecoturismo</option>
                    <option value="Rafting">ğŸš£ Rafting</option>
                    <option value="Parque AquÃ¡tico">ğŸŒŠ Parque AquÃ¡tico</option>
                    <option value="Museu">ğŸ›ï¸ Museu</option>
                    <option value="Galeria de Arte">ğŸ¨ Galeria de Arte</option>
                    <option value="Cinema">ğŸ¬ Cinema</option>
                    <option value="Teatro">ğŸ­ Teatro</option>
                    <option value="Parque de DiversÃµes">ğŸ¡ Parque de DiversÃµes</option>
                    <option value="GinÃ¡sio Esportivo">âš½ GinÃ¡sio Esportivo</option>
                    <option value="Campo de Futebol">âš½ Campo de Futebol</option>
                    <option value="Quadra de TÃªnis">ğŸ¾ Quadra de TÃªnis</option>
                    <option value="Spa e Wellness">ğŸ’† Spa e Wellness</option>
                    <option value="Academia de GinÃ¡stica">ğŸ’ª Academia de GinÃ¡stica</option>
                    <option value="Yoga e Pilates">ğŸ§˜ Yoga e Pilates</option>
                    <option value="Loja de Roupas">ğŸ‘” Loja de Roupas</option>
                    <option value="Loja de Artesanato">ğŸ Loja de Artesanato</option>
                    <option value="Loja de Souvenirs">ğŸ›ï¸ Loja de Souvenirs</option>
                    <option value="Joalharia">ğŸ’ Joalharia</option>
                    <option value="FarmÃ¡cia">ğŸ’Š FarmÃ¡cia</option>
                    <option value="ClÃ­nica MÃ©dica">âš•ï¸ ClÃ­nica MÃ©dica</option>
                    <option value="ConsultÃ³rio OdontolÃ³gico">ğŸ¦· ConsultÃ³rio OdontolÃ³gico</option>
                    <option value="SalÃ£o de Beleza">ğŸ’… SalÃ£o de Beleza</option>
                    <option value="Barbershop">ğŸ’ˆ Barbershop</option>
                    <option value="Cabeleireiro">âœ‚ï¸ Cabeleireiro</option>
                    <option value="TÃ¡xi">ğŸš• TÃ¡xi</option>
                    <option value="Aluguel de Carro">ğŸš— Aluguel de Carro</option>
                    <option value="Moto TÃ¡xi">ğŸï¸ Moto TÃ¡xi</option>
                    <option value="Transporte">ğŸš Transporte</option>
                    <option value="Livraria">ğŸ“š Livraria</option>
                    <option value="Biblioteca">ğŸ“– Biblioteca</option>
                    <option value="Escola">ğŸ“ Escola</option>
                    <option value="Cursos">ğŸ“ Cursos</option>
                    <option value="Consultoria">ğŸ’¼ Consultoria</option>
                    <option value="EscritÃ³rio de Advocacia">âš–ï¸ EscritÃ³rio de Advocacia</option>
                    <option value="Contabilidade">ğŸ“Š Contabilidade</option>
                    <option value="Seguros">ğŸ›¡ï¸ Seguros</option>
                    <option value="ImobiliÃ¡ria">ğŸ˜ï¸ ImobiliÃ¡ria</option>
                    <option value="FotÃ³grafo">ğŸ“· FotÃ³grafo</option>
                    <option value="EstÃºdio de Fotografia">ğŸ“¸ EstÃºdio de Fotografia</option>
                    <option value="VideÃ³grafo">ğŸ¥ VideÃ³grafo</option>
                    <option value="DJ e MÃºsica">ğŸµ DJ e MÃºsica</option>
                    <option value="Casamento e Eventos">ğŸ‰ Casamento e Eventos</option>
                    <option value="DecoraÃ§Ã£o">ğŸ€ DecoraÃ§Ã£o</option>
                    <option value="Flores">ğŸŒ¹ Flores</option>
                    <option value="Padaria Artesanal">ğŸ¥– Padaria Artesanal</option>
                    <option value="Confeitaria">ğŸ‚ Confeitaria</option>
                    <option value="AÃ§ougue">ğŸ¥© AÃ§ougue</option>
                    <option value="Peixaria">ğŸŸ Peixaria</option>
                    <option value="Feira de OrgÃ¢nicos">ğŸ¥¬ Feira de OrgÃ¢nicos</option>
                    <option value="Supermercado">ğŸ›’ Supermercado</option>
                    <option value="Mercado">ğŸª Mercado</option>
                    <option value="AÃ§ai e Drinks">ğŸ¥¤ AÃ§ai e Drinks</option>
                    <option value="Smoothie Bar">ğŸ¥— Smoothie Bar</option>
                    <option value="Pastel">ğŸ¥ Pastel</option>
                    <option value="Coxinha">ğŸ— Coxinha</option>
                    <option value="Tapioca">ğŸ² Tapioca</option>
                    <option value="Comida Vegana">ğŸŒ± Comida Vegana</option>
                    <option value="Comida Fitness">ğŸ¥— Comida Fitness</option>
                    <option value="ConveniÃªncia">ğŸ¬ ConveniÃªncia</option>
                    <option value="Agropet">ğŸ¾ Agropet</option>
                    <option value="Posto de Gasolina">â›½ Posto de Gasolina</option>
                    <option value="Lavagem de Carro">ğŸš— Lavagem de Carro</option>
                    <option value="MecÃ¢nica">ğŸ”§ MecÃ¢nica</option>
                    <option value="Eletricista">âš¡ Eletricista</option>
                    <option value="Encanador">ğŸ”¨ Encanador</option>
                    <option value="ConstruÃ§Ã£o">ğŸ—ï¸ ConstruÃ§Ã£o</option>
                    <option value="ImÃ³vel Comercial">ğŸ¢ ImÃ³vel Comercial</option>
                    <option value="Outro">â• Outro</option>
                </select>
            </div>
            <div class="form-group">
                <label>Cidade</label>
                <select id="business-city" required>
                    <option value="">-- Selecione a cidade --</option>
                    <option value="Quatis">Quatis</option>
                    <option value="Porto Real">Porto Real</option>
                    <option value="Resende">Resende</option>
                    <option value="Barra Mansa">Barra Mansa</option>
                    <option value="Itatiaia">Itatiaia</option>
                </select>
            </div>
            <div class="form-group">
                <label>Imagem</label>
                <input type="file" id="business-image" accept="image/*" placeholder="Selecione uma imagem">
                <small style="color: #666; margin-top: 5px; display: block;">Formatos suportados: JPG, PNG (mÃ¡x. 5MB)</small>
            </div>
            <div class="form-group">
                <label>Plano</label>
                <select id="business-plan" required>
                    <option value="">-- Selecione o plano --</option>
                    <option value="Free">Free</option>
                    <option value="Start">Start (R$ 29,90/mÃªs)</option>
                    <option value="Plus">Plus (R$ 49,90/mÃªs)</option>
                    <option value="Elite">Elite (R$ 79,90/mÃªs)</option>
                </select>
            </div>
            <div class="flex gap-3">
                <button onclick="closeBusinessModal()" class="flex-1 btn" style="background: #e9ecef; color: #333;">Cancelar</button>
                <button onclick="saveBusiness()" class="flex-1 btn btn-primary" id="business-submit-btn">Criar</button>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6">Editar UsuÃ¡rio</h2>
            <div class="form-group">
                <label>Nome</label>
                <input type="text" id="user-name" placeholder="Nome do usuÃ¡rio">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="user-email" placeholder="Email" readonly>
            </div>
            <div class="form-group">
                <label>Tipo</label>
                <select id="user-role">
                    <option value="user">UsuÃ¡rio</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="flex gap-3">
                <button onclick="closeUserModal()" class="flex-1 btn" style="background: #e9ecef; color: #333;">Cancelar</button>
                <button onclick="saveUser()" class="flex-1 btn btn-primary">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6" id="event-modal-title">Novo Evento</h2>
            <div class="form-group">
                <label>Nome</label>
                <input type="text" id="event-name" placeholder="Nome do evento">
            </div>
            <div class="form-group">
                <label>NegÃ³cio ID</label>
                <input type="text" id="event-business" placeholder="ID do negÃ³cio">
            </div>
            <div class="form-group">
                <label>Data</label>
                <input type="datetime-local" id="event-date">
            </div>
            <div class="form-group">
                <label>Local</label>
                <input type="text" id="event-location" placeholder="Local do evento">
            </div>
            <div class="form-group">
                <label>Foto do Evento</label>
                <input type="file" id="event-image" accept="image/*" placeholder="Selecione uma imagem">
                <small style="color: #666; margin-top: 5px; display: block;">Formatos suportados: JPG, PNG (mÃ¡x. 5MB)</small>
            </div>
            <div class="flex gap-3">
                <button onclick="closeEventModal()" class="flex-1 btn" style="background: #e9ecef; color: #333;">Cancelar</button>
                <button onclick="saveEvent()" class="flex-1 btn btn-primary" id="event-submit-btn">Criar</button>
            </div>
        </div>
    </div>

    <!-- Seal Modal -->
    <div id="sealModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6">Adicionar Selo</h2>
            <div class="form-group">
                <label>NegÃ³cio</label>
                <select id="seal-business" required>
                    <option value="">-- Selecione o negÃ³cio --</option>
                </select>
            </div>
            <div class="form-group">
                <label>Tipo de Selo</label>
                <select id="seal-type" required>
                    <option value="">-- Selecione o tipo --</option>
                    <option value="verified">âœ“ Verificado</option>
                    <option value="top-rated">â­ Top Avaliado</option>
                    <option value="excellent">ğŸ’ Excelente</option>
                    <option value="award-winning">ğŸ† Premiado</option>
                </select>
            </div>
            <div class="flex gap-3">
                <button onclick="closeSealModal()" class="flex-1 btn" style="background: #e9ecef; color: #333;">Cancelar</button>
                <button onclick="saveSeal()" class="flex-1 btn btn-primary">Adicionar</button>
            </div>
        </div>
    </div>

    <!-- Coupon Modal -->
    <div id="couponModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6" id="coupon-modal-title">Novo Cupom</h2>
            <div class="form-group">
                <label>CÃ³digo (sem espaÃ§os)</label>
                <input type="text" id="coupon-code" placeholder="Ex: PROMO20" style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label>NegÃ³cio</label>
                <select id="coupon-business" required>
                    <option value="">-- Selecione o negÃ³cio --</option>
                </select>
            </div>
            <div class="form-group">
                <label>DescriÃ§Ã£o</label>
                <input type="text" id="coupon-description" placeholder="Ex: Desconto especial de 20%">
            </div>
            <div class="form-group">
                <label>Tipo de Desconto</label>
                <select id="coupon-type">
                    <option value="percentage">Percentual (%)</option>
                    <option value="fixed">Valor Fixo (R$)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Valor de Desconto</label>
                <input type="number" id="coupon-value" placeholder="Ex: 20" min="0">
            </div>
            <div class="form-group">
                <label>Limite de Usos (deixe em branco para ilimitado)</label>
                <input type="number" id="coupon-max-uses" placeholder="Ex: 100" min="0">
            </div>
            <div class="form-group">
                <label>Data de ExpiraÃ§Ã£o</label>
                <input type="date" id="coupon-expires">
            </div>
            <div class="flex gap-3">
                <button onclick="closeCouponModal()" class="flex-1 btn" style="background: #e9ecef; color: #333;">Cancelar</button>
                <button onclick="saveCoupon()" class="flex-1 btn btn-primary" id="coupon-submit-btn">Criar</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://vivacidade-brasil-api.onrender.com/api';
        let adminToken = localStorage.getItem('admin_token');
        let adminUser = JSON.parse(localStorage.getItem('admin_user') || '{}');
        
        // Estado para ediÃ§Ã£o
        let editingBusinessId = null;
        let editingEventId = null;
        let editingUserId = null;

        // Chart instances
        let categoriesChart = null;
        let citiesChart = null;

        // Check authentication
        window.addEventListener('load', () => {
            if (!adminToken) {
                window.location.href = '/admin/login.html';
                return;
            }
            loadDashboardData();
            displayAdminUser();
        });

        function displayAdminUser() {
            const userDiv = document.getElementById('admin-user');
            userDiv.innerHTML = `
                <p class="text-gray-800 font-600">${adminUser.name || 'Admin'}</p>
                <p class="text-sm text-gray-500">${adminUser.email}</p>
            `;
        }

        function switchSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');

            // Load data for section
            if (sectionName === 'businesses') loadBusinesses();
            else if (sectionName === 'users') loadUsers();
            else if (sectionName === 'reviews') loadReviews();
            else if (sectionName === 'events') loadEvents();
            else if (sectionName === 'seals') loadSealsData();
            else if (sectionName === 'coupons') loadCouponsData();
        }

        async function loadDashboardData() {
            try {
                const [businessesRes, usersRes, reviewsRes, eventsRes] = await Promise.all([
                    fetch(`${API_URL}/businesses`, { headers: { 'Authorization': `Bearer ${adminToken}` } }),
                    fetch(`${API_URL}/admin/users`, { headers: { 'Authorization': `Bearer ${adminToken}` } }),
                    fetch(`${API_URL}/admin/reviews`, { headers: { 'Authorization': `Bearer ${adminToken}` } }),
                    fetch(`${API_URL}/admin/events`, { headers: { 'Authorization': `Bearer ${adminToken}` } })
                ]);

                const businesses = await businessesRes.json();
                const users = await usersRes.json();
                const reviews = await reviewsRes.json();
                const events = await eventsRes.json();

                document.getElementById('total-businesses').textContent = Array.isArray(businesses) ? businesses.length : 0;
                document.getElementById('total-users').textContent = Array.isArray(users) ? users.length : 0;
                document.getElementById('total-reviews').textContent = Array.isArray(reviews) ? reviews.length : 0;
                document.getElementById('total-events').textContent = Array.isArray(events) ? events.length : 0;

                // Carregar grÃ¡ficos
                loadCharts(businesses);
            } catch (err) {
                console.error('Erro ao carregar dados:', err);
            }
        }

        function loadCharts(businesses) {
            if (!Array.isArray(businesses)) return;

            // GrÃ¡fico de categorias
            const categories = {};
            businesses.forEach(b => {
                const cat = b.category || 'Sem categoria';
                categories[cat] = (categories[cat] || 0) + 1;
            });

            const categoryCtx = document.getElementById('categoriesChart');
            if (categoryCtx && categoriesChart) categoriesChart.destroy();
            if (categoryCtx) {
                categoriesChart = new Chart(categoryCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(categories),
                        datasets: [{
                            data: Object.values(categories),
                            backgroundColor: [
                                '#0066FF', '#00B4A0', '#f39c12', '#e74c3c', '#9b59b6',
                                '#3498db', '#1abc9c', '#f1c40f', '#e67e22', '#95a5a6'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }

            // GrÃ¡fico de cidades
            const cities = {};
            businesses.forEach(b => {
                const city = b.city || 'Sem cidade';
                cities[city] = (cities[city] || 0) + 1;
            });

            const cityCtx = document.getElementById('citiesChart');
            if (cityCtx && citiesChart) citiesChart.destroy();
            if (cityCtx) {
                citiesChart = new Chart(cityCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(cities),
                        datasets: [{
                            label: 'NegÃ³cios',
                            data: Object.values(cities),
                            backgroundColor: 'rgba(0, 102, 255, 0.6)',
                            borderColor: '#0066FF',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
        }

        async function loadBusinesses() {
            try {
                const res = await fetch(`${API_URL}/businesses`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const businesses = await res.json();
                const tbody = document.getElementById('businesses-table');

                if (!Array.isArray(businesses) || businesses.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">Nenhum negÃ³cio cadastrado</td></tr>';
                    return;
                }

                tbody.innerHTML = businesses.map(b => `
                    <tr>
                        <td><strong>${b.name}</strong></td>
                        <td>${b.category || '-'}</td>
                        <td>${b.city || '-'}</td>
                        <td>${b.owner || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-edit" onclick="editBusiness('${b._id}', '${escapeQuotes(b.name)}', '${escapeQuotes(b.category || '')}', '${escapeQuotes(b.city || '')}', '${escapeQuotes(b.description || '')}', '${b.plan || 'Free'}')">âœï¸ Editar</button>
                                <button class="btn btn-danger" onclick="deleteBusiness('${b._id}')">ğŸ—‘ï¸ Deletar</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error(err);
                document.getElementById('businesses-table').innerHTML = '<tr><td colspan="5" class="text-center py-8 text-red-500">Erro ao carregar negÃ³cios</td></tr>';
            }
        }

        async function loadUsers() {
            try {
                const res = await fetch(`${API_URL}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const users = await res.json();
                const tbody = document.getElementById('users-table');

                if (!Array.isArray(users) || users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">Nenhum usuÃ¡rio cadastrado</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td><strong>${u.name}</strong></td>
                        <td>${u.email}</td>
                        <td><span class="badge ${u.role === 'admin' ? 'badge-danger' : 'badge-success'}">${u.role === 'admin' ? 'Admin' : 'UsuÃ¡rio'}</span></td>
                        <td>${new Date(u.createdAt).toLocaleDateString('pt-BR')}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-edit" onclick="editUser('${u._id}', '${escapeQuotes(u.name)}', '${u.email}', '${u.role}')">âœï¸ Editar</button>
                                <button class="btn btn-danger" onclick="deleteUser('${u._id}')">ğŸ—‘ï¸ Deletar</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error(err);
                document.getElementById('users-table').innerHTML = '<tr><td colspan="5" class="text-center py-8 text-red-500">Erro ao carregar usuÃ¡rios</td></tr>';
            }
        }

        async function loadReviews() {
            try {
                const res = await fetch(`${API_URL}/admin/reviews`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const reviews = await res.json();
                const tbody = document.getElementById('reviews-table');

                if (!Array.isArray(reviews) || reviews.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">Nenhuma avaliaÃ§Ã£o cadastrada</td></tr>';
                    return;
                }

                tbody.innerHTML = reviews.map(r => `
                    <tr>
                        <td>${r.businessId || '-'}</td>
                        <td>${r.userId || '-'}</td>
                        <td><span class="badge badge-warning">${r.rating} â­</span></td>
                        <td>${r.comment ? r.comment.substring(0, 30) + '...' : '-'}</td>
                        <td>${new Date(r.createdAt).toLocaleDateString('pt-BR')}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteReview('${r._id}')">ğŸ—‘ï¸ Deletar</button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error(err);
                document.getElementById('reviews-table').innerHTML = '<tr><td colspan="6" class="text-center py-8 text-red-500">Erro ao carregar avaliaÃ§Ãµes</td></tr>';
            }
        }

        async function loadEvents() {
            try {
                const res = await fetch(`${API_URL}/admin/events`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const events = await res.json();
                const tbody = document.getElementById('events-table');

                if (!Array.isArray(events) || events.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">Nenhum evento cadastrado</td></tr>';
                    return;
                }

                tbody.innerHTML = events.map(e => `
                    <tr>
                        <td><strong>${e.name}</strong></td>
                        <td>${e.businessId || '-'}</td>
                        <td>${new Date(e.date).toLocaleDateString('pt-BR')}</td>
                        <td>${e.location || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-edit" onclick="editEvent('${e._id}', '${escapeQuotes(e.name)}', '${e.businessId}', '${e.date}', '${escapeQuotes(e.location || '')}')">âœï¸ Editar</button>
                                <button class="btn btn-danger" onclick="deleteEvent('${e._id}')">ğŸ—‘ï¸ Deletar</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error(err);
                document.getElementById('events-table').innerHTML = '<tr><td colspan="5" class="text-center py-8 text-red-500">Erro ao carregar eventos</td></tr>';
            }
        }

        // Utility function to escape quotes
        function escapeQuotes(str) {
            return (str || '').replace(/'/g, "\\'");
        }

        // Business Modal Functions
        function openBusinessModal() {
            editingBusinessId = null;
            document.getElementById('business-modal-title').textContent = 'Novo NegÃ³cio';
            document.getElementById('business-submit-btn').textContent = 'Criar';
            document.getElementById('business-name').value = '';
            document.getElementById('business-desc').value = '';
            document.getElementById('business-category').value = '';
            document.getElementById('business-city').value = '';
            document.getElementById('business-plan').value = '';
            document.getElementById('business-image').value = '';
            document.getElementById('businessModal').classList.add('active');
        }

        function closeBusinessModal() {
            document.getElementById('businessModal').classList.remove('active');
            editingBusinessId = null;
        }

        function editBusiness(id, name, category, city, desc, plan) {
            editingBusinessId = id;
            document.getElementById('business-modal-title').textContent = 'Editar NegÃ³cio';
            document.getElementById('business-submit-btn').textContent = 'Salvar';
            document.getElementById('business-name').value = name;
            document.getElementById('business-category').value = category;
            document.getElementById('business-city').value = city;
            document.getElementById('business-desc').value = desc;
            document.getElementById('business-plan').value = plan || 'Free';
            document.getElementById('business-image').value = '';
            document.getElementById('businessModal').classList.add('active');
        }

        async function saveBusiness() {
            const name = document.getElementById('business-name').value;
            const description = document.getElementById('business-desc').value;
            const category = document.getElementById('business-category').value;
            const city = document.getElementById('business-city').value;
            const plan = document.getElementById('business-plan').value;
            const imageFile = document.getElementById('business-image').files[0];

            if (!name || !category || !city || !plan) {
                alert('Preencha todos os campos obrigatÃ³rios (incluindo o plano)');
                return;
            }

            try {
                let businessData = { name, description, category, city, plan };
                
                // Se houver imagem, fazer upload primeiro
                if (imageFile) {
                    const formData = new FormData();
                    formData.append('image', imageFile);
                    formData.append('businessId', editingBusinessId || 'new');

                    const uploadRes = await fetch(`${API_URL}/upload`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${adminToken}`
                        },
                        body: formData
                    });

                    if (uploadRes.ok) {
                        const uploadData = await uploadRes.json();
                        businessData.image = uploadData.imageUrl || uploadData.url;
                    } else {
                        console.warn('Erro ao fazer upload da imagem, continuando sem imagem');
                    }
                }

                const method = editingBusinessId ? 'PUT' : 'POST';
                const url = editingBusinessId 
                    ? `${API_URL}/businesses/${editingBusinessId}`
                    : `${API_URL}/businesses`;

                const res = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify(businessData)
                });

                if (res.ok) {
                    alert(editingBusinessId ? 'NegÃ³cio atualizado com sucesso!' : 'NegÃ³cio criado com sucesso!');
                    closeBusinessModal();
                    loadBusinesses();
                    loadDashboardData();
                } else {
                    let errorMessage = 'Erro ao salvar negÃ³cio';
                    try {
                        const error = await res.json();
                        errorMessage = error.error || error.message || errorMessage;
                    } catch (e) {
                        errorMessage = `Erro ao salvar negÃ³cio (HTTP ${res.status})`;
                    }
                    alert(errorMessage);
                }
            } catch (err) {
                console.error('Erro ao conectar com servidor:', err);
                alert(`Erro ao conectar com o servidor: ${err.message || 'Verifique sua conexÃ£o de internet'}`);
            }
        }

        // User Modal Functions
        function editUser(id, name, email, role) {
            editingUserId = id;
            document.getElementById('user-name').value = name;
            document.getElementById('user-email').value = email;
            document.getElementById('user-role').value = role;
            document.getElementById('userModal').classList.add('active');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
            editingUserId = null;
        }

        async function saveUser() {
            const name = document.getElementById('user-name').value;
            const role = document.getElementById('user-role').value;

            if (!name) {
                alert('Preencha o nome');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/admin/users/${editingUserId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ name, role })
                });

                if (res.ok) {
                    alert('UsuÃ¡rio atualizado com sucesso!');
                    closeUserModal();
                    loadUsers();
                } else {
                    alert('Erro ao atualizar usuÃ¡rio');
                }
            } catch (err) {
                console.error(err);
                alert('Erro ao conectar com o servidor');
            }
        }

        // Event Modal Functions
        function openEventModal() {
            editingEventId = null;
            document.getElementById('event-modal-title').textContent = 'Novo Evento';
            document.getElementById('event-submit-btn').textContent = 'Criar';
            document.getElementById('event-name').value = '';
            document.getElementById('event-business').value = '';
            document.getElementById('event-date').value = '';
            document.getElementById('event-location').value = '';
            document.getElementById('event-image').value = '';
            document.getElementById('eventModal').classList.add('active');
        }

        function closeEventModal() {
            document.getElementById('eventModal').classList.remove('active');
            editingEventId = null;
        }

        function editEvent(id, name, businessId, date, location) {
            editingEventId = id;
            document.getElementById('event-modal-title').textContent = 'Editar Evento';
            document.getElementById('event-submit-btn').textContent = 'Salvar';
            document.getElementById('event-name').value = name;
            document.getElementById('event-business').value = businessId;
            document.getElementById('event-date').value = date.slice(0, 16);
            document.getElementById('event-location').value = location;
            document.getElementById('event-image').value = '';
            document.getElementById('eventModal').classList.add('active');
        }

        async function saveEvent() {
            const name = document.getElementById('event-name').value;
            const businessId = document.getElementById('event-business').value;
            const date = document.getElementById('event-date').value;
            const location = document.getElementById('event-location').value;
            const imageFile = document.getElementById('event-image').files[0];

            if (!name || !businessId || !date || !location) {
                alert('Preencha todos os campos obrigatÃ³rios');
                return;
            }

            try {
                let eventData = { name, businessId, date, location };
                
                // Se houver imagem, fazer upload primeiro
                if (imageFile) {
                    const formData = new FormData();
                    formData.append('image', imageFile);
                    formData.append('eventId', editingEventId || 'new');

                    const uploadRes = await fetch(`${API_URL}/upload`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${adminToken}`
                        },
                        body: formData
                    });

                    if (uploadRes.ok) {
                        const uploadData = await uploadRes.json();
                        eventData.image = uploadData.imageUrl || uploadData.url;
                    } else {
                        console.warn('Erro ao fazer upload da imagem, continuando sem imagem');
                    }
                }

                const method = editingEventId ? 'PUT' : 'POST';
                const url = editingEventId 
                    ? `${API_URL}/admin/events/${editingEventId}`
                    : `${API_URL}/admin/events`;

                const res = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify(eventData)
                });

                if (res.ok) {
                    alert(editingEventId ? 'Evento atualizado com sucesso!' : 'Evento criado com sucesso!');
                    closeEventModal();
                    loadEvents();
                    loadDashboardData();
                } else {
                    let errorMessage = 'Erro ao salvar evento';
                    try {
                        const error = await res.json();
                        errorMessage = error.error || error.message || errorMessage;
                    } catch (e) {
                        errorMessage = `Erro ao salvar evento (HTTP ${res.status})`;
                    }
                    alert(errorMessage);
                }
            } catch (err) {
                console.error('Erro ao conectar com servidor:', err);
                alert(`Erro ao conectar com o servidor: ${err.message || 'Verifique sua conexÃ£o de internet'}`);
            }
        }

        // Delete functions
        async function deleteBusiness(id) {
            if (!confirm('Tem certeza que deseja deletar este negÃ³cio?')) return;

            try {
                const res = await fetch(`${API_URL}/businesses/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                if (res.ok) {
                    alert('NegÃ³cio deletado com sucesso!');
                    loadBusinesses();
                    loadDashboardData();
                }
            } catch (err) {
                console.error(err);
                alert('Erro ao deletar negÃ³cio');
            }
        }

        async function deleteUser(id) {
            if (!confirm('Tem certeza que deseja deletar este usuÃ¡rio?')) return;

            try {
                const res = await fetch(`${API_URL}/admin/users/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                if (res.ok) {
                    alert('UsuÃ¡rio deletado com sucesso!');
                    loadUsers();
                }
            } catch (err) {
                console.error(err);
                alert('Erro ao deletar usuÃ¡rio');
            }
        }

        async function deleteReview(id) {
            if (!confirm('Tem certeza que deseja deletar esta avaliaÃ§Ã£o?')) return;

            try {
                const res = await fetch(`${API_URL}/admin/reviews/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                if (res.ok) {
                    alert('AvaliaÃ§Ã£o deletada com sucesso!');
                    loadReviews();
                    loadDashboardData();
                }
            } catch (err) {
                console.error(err);
                alert('Erro ao deletar avaliaÃ§Ã£o');
            }
        }

        async function deleteEvent(id) {
            if (!confirm('Tem certeza que deseja deletar este evento?')) return;

            try {
                const res = await fetch(`${API_URL}/admin/events/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                if (res.ok) {
                    alert('Evento deletado com sucesso!');
                    loadEvents();
                    loadDashboardData();
                }
            } catch (err) {
                console.error(err);
                alert('Erro ao deletar evento');
            }
        }

        function logout() {
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_user');
            window.location.href = '/admin/login.html';
        }

        // Seal Modal Functions
        async function loadSealsData() {
            try {
                const [businessesRes, businessListRes] = await Promise.all([
                    fetch(`${API_URL}/businesses`, { headers: { 'Authorization': `Bearer ${adminToken}` } }),
                    fetch(`${API_URL}/businesses`, { headers: { 'Authorization': `Bearer ${adminToken}` } })
                ]);

                const businesses = await businessesRes.json();
                const tbody = document.getElementById('seals-table');

                if (!Array.isArray(businesses) || businesses.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">Nenhum negÃ³cio cadastrado</td></tr>';
                    return;
                }

                tbody.innerHTML = businesses.map(b => `
                    <tr>
                        <td><strong>${b.name}</strong></td>
                        <td>
                            <div class="flex gap-1 flex-wrap">
                                ${(b.seals || []).map(seal => {
                                    const labels = { verified: 'âœ“', 'top-rated': 'â­', excellent: 'ğŸ’', 'award-winning': 'ğŸ†' };
                                    return `<span class="badge badge-success" style="cursor: pointer;" onclick="removeSeal('${b._id}', '${seal}')">${labels[seal]} Ã—</span>`;
                                }).join('')}
                            </div>
                        </td>
                        <td>${(b.rating || 0).toFixed(1)} â­</td>
                        <td>${b.reviews ? b.reviews.length : 0}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="openSealModalForBusiness('${b._id}')">+ Selo</button>
                        </td>
                    </tr>
                `).join('');

                // Preencher select de negÃ³cios
                const select = document.getElementById('seal-business');
                select.innerHTML = '<option value="">-- Selecione o negÃ³cio --</option>' + businesses.map(b => `<option value="${b._id}">${b.name}</option>`).join('');
            } catch (err) {
                console.error(err);
                document.getElementById('seals-table').innerHTML = '<tr><td colspan="5" class="text-center py-8 text-red-500">Erro ao carregar selos</td></tr>';
            }
        }

        function openSealModal() {
            editingSealBusinessId = null;
            document.getElementById('seal-business').value = '';
            document.getElementById('seal-type').value = '';
            document.getElementById('sealModal').classList.add('active');
        }

        function openSealModalForBusiness(businessId) {
            editingSealBusinessId = businessId;
            document.getElementById('seal-business').value = businessId;
            document.getElementById('seal-type').value = '';
            document.getElementById('sealModal').classList.add('active');
        }

        function closeSealModal() {
            document.getElementById('sealModal').classList.remove('active');
            editingSealBusinessId = null;
        }

        async function removeSeal(businessId, sealType) {
            if (!confirm(`Remover selo "${sealType}"?`)) return;

            try {
                const res = await fetch(`${API_URL}/admin/seals/${businessId}/${sealType}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                if (res.ok) {
                    loadSealsData();
                    loadDashboardData();
                } else {
                    alert('Erro ao remover selo');
                }
            } catch (err) {
                alert('Erro ao conectar com servidor');
            }
        }

        async function saveSeal() {
            const businessId = document.getElementById('seal-business').value;
            const sealType = document.getElementById('seal-type').value;

            if (!businessId || !sealType) {
                alert('Selecione o negÃ³cio e o tipo de selo');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/admin/seals/${businessId}/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ sealType })
                });

                if (res.ok) {
                    alert('Selo adicionado com sucesso!');
                    closeSealModal();
                    loadSealsData();
                    loadDashboardData();
                } else {
                    alert('Erro ao adicionar selo');
                }
            } catch (err) {
                alert('Erro ao conectar com servidor');
            }
        }

        // Coupon Modal Functions
        async function loadCouponsData() {
            try {
                const [couponsRes, businessListRes] = await Promise.all([
                    fetch(`${API_URL}/admin/coupons`, { headers: { 'Authorization': `Bearer ${adminToken}` } }),
                    fetch(`${API_URL}/businesses`, { headers: { 'Authorization': `Bearer ${adminToken}` } })
                ]);

                const coupons = await couponsRes.json();
                const businesses = await businessListRes.json();
                const tbody = document.getElementById('coupons-table');

                if (!Array.isArray(coupons) || coupons.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">Nenhum cupom cadastrado</td></tr>';
                } else {
                    tbody.innerHTML = coupons.map(c => `
                        <tr>
                            <td><strong>${c.code}</strong></td>
                            <td>${c.businessId && c.businessId.name ? c.businessId.name : 'N/A'}</td>
                            <td>${c.discountType === 'percentage' ? c.discountValue + '%' : 'R$ ' + (c.discountValue / 100).toFixed(2)}</td>
                            <td>${c.usedCount || 0}${c.maxUses ? ' / ' + c.maxUses : ''}</td>
                            <td>${c.expiresAt ? new Date(c.expiresAt).toLocaleDateString('pt-BR') : 'Sem expiraÃ§Ã£o'}</td>
                            <td><span class="badge ${c.active ? 'badge-success' : 'badge-danger'}">${c.active ? 'Ativo' : 'Inativo'}</span></td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deleteCoupon('${c._id}')">ğŸ—‘ï¸</button>
                            </td>
                        </tr>
                    `).join('');
                }

                // Preencher select de negÃ³cios
                const select = document.getElementById('coupon-business');
                select.innerHTML = '<option value="">-- Selecione o negÃ³cio --</option>' + businesses.map(b => `<option value="${b._id}">${b.name}</option>`).join('');
            } catch (err) {
                console.error(err);
                document.getElementById('coupons-table').innerHTML = '<tr><td colspan="7" class="text-center py-8 text-red-500">Erro ao carregar cupons</td></tr>';
            }
        }

        function openCouponModal() {
            editingCouponId = null;
            document.getElementById('coupon-modal-title').textContent = 'Novo Cupom';
            document.getElementById('coupon-submit-btn').textContent = 'Criar';
            document.getElementById('coupon-code').value = '';
            document.getElementById('coupon-business').value = '';
            document.getElementById('coupon-description').value = '';
            document.getElementById('coupon-type').value = 'percentage';
            document.getElementById('coupon-value').value = '';
            document.getElementById('coupon-max-uses').value = '';
            document.getElementById('coupon-expires').value = '';
            document.getElementById('couponModal').classList.add('active');
        }

        function closeCouponModal() {
            document.getElementById('couponModal').classList.remove('active');
            editingCouponId = null;
        }

        async function saveCoupon() {
            const code = document.getElementById('coupon-code').value.trim();
            const businessId = document.getElementById('coupon-business').value;
            const description = document.getElementById('coupon-description').value;
            const discountType = document.getElementById('coupon-type').value;
            const discountValue = parseFloat(document.getElementById('coupon-value').value);
            const maxUses = parseInt(document.getElementById('coupon-max-uses').value) || null;
            const expiresAt = document.getElementById('coupon-expires').value;

            if (!code || !businessId || !discountValue) {
                alert('Preencha os campos obrigatÃ³rios');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/admin/coupons`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({
                        code,
                        businessId,
                        description,
                        discountType,
                        discountValue,
                        maxUses,
                        expiresAt: expiresAt ? new Date(expiresAt).toISOString() : null
                    })
                });

                if (res.ok) {
                    alert('Cupom criado com sucesso!');
                    closeCouponModal();
                    loadCouponsData();
                    loadDashboardData();
                } else {
                    const error = await res.json();
                    alert(`Erro: ${error.error}`);
                }
            } catch (err) {
                alert('Erro ao conectar com servidor');
            }
        }

        async function deleteCoupon(couponId) {
            if (!confirm('Deletar este cupom?')) return;

            try {
                const res = await fetch(`${API_URL}/admin/coupons/${couponId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                if (res.ok) {
                    loadCouponsData();
                    loadDashboardData();
                } else {
                    alert('Erro ao deletar cupom');
                }
            } catch (err) {
                alert('Erro ao conectar com servidor');
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const businessModal = document.getElementById('businessModal');
            const userModal = document.getElementById('userModal');
            const eventModal = document.getElementById('eventModal');
            const sealModal = document.getElementById('sealModal');
            const couponModal = document.getElementById('couponModal');
            
            if (event.target === businessModal) closeBusinessModal();
            if (event.target === userModal) closeUserModal();
            if (event.target === eventModal) closeEventModal();
            if (event.target === sealModal) closeSealModal();
            if (event.target === couponModal) closeCouponModal();
        }
    </script>
</body>
</html>
