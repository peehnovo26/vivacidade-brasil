<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Painel - VivaCidade Brasil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #f0f4f8;
        }
        .sidebar {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
        }
        .nav-item {
            transition: all 0.3s ease;
        }
        .nav-item:hover {
            transform: translateX(4px);
            background: rgba(0, 102, 255, 0.1);
        }
        .nav-item.active {
            background: linear-gradient(135deg, #0066FF 0%, #00B4A0 100%);
            border-left: 4px solid white;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #0066FF 0%, #00B4A0 100%);
            color: white;
        }
        .btn-primary:hover {
            opacity: 0.9;
        }
        .btn-danger {
            background: #ff4757;
            color: white;
        }
        .btn-danger:hover {
            background: #ff3838;
        }
        .btn-edit {
            background: #f39c12;
            color: white;
        }
        .btn-edit:hover {
            background: #e67e22;
        }
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background: #f8f9fa;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e9ecef;
        }
        td {
            padding: 16px;
            border-bottom: 1px solid #e9ecef;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0066FF 0%, #00B4A0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: white;
            flex-shrink: 0;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-family: inherit;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #0066FF;
            box-shadow: 0 0 0 3px rgba(0,102,255,0.1);
        }
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            .profile-header {
                flex-direction: column;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-64 text-white p-6">
            <div class="flex items-center mb-8">
                <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-teal-500 rounded-lg flex items-center justify-center font-bold text-white mr-3">VC</div>
                <div>
                    <h1 class="text-xl font-bold">VivaCidade</h1>
                    <p class="text-xs text-gray-400">Meu Painel</p>
                </div>
            </div>

            <hr class="border-gray-600 mb-6">

            <nav class="space-y-2">
                <div class="nav-item active px-4 py-3 rounded-lg cursor-pointer flex items-center" onclick="switchSection('profile')">
                    <span class="text-xl mr-3">üë§</span>
                    <span>Meu Perfil</span>
                </div>
                <div class="nav-item px-4 py-3 rounded-lg cursor-pointer flex items-center" onclick="switchSection('my-businesses')">
                    <span class="text-xl mr-3">üè™</span>
                    <span>Meus Neg√≥cios</span>
                </div>
                <div class="nav-item px-4 py-3 rounded-lg cursor-pointer flex items-center" onclick="switchSection('my-reviews')">
                    <span class="text-xl mr-3">‚≠ê</span>
                    <span>Minhas Avalia√ß√µes</span>
                </div>
                <div class="nav-item px-4 py-3 rounded-lg cursor-pointer flex items-center" onclick="switchSection('favorites')">
                    <span class="text-xl mr-3">‚ù§Ô∏è</span>
                    <span>Favoritos</span>
                </div>
                <div class="nav-item px-4 py-3 rounded-lg cursor-pointer flex items-center" onclick="switchSection('settings')">
                    <span class="text-xl mr-3">‚öôÔ∏è</span>
                    <span>Configura√ß√µes</span>
                </div>
            </nav>

            <hr class="border-gray-600 my-6">

            <button onclick="logout()" class="w-full px-4 py-3 rounded-lg bg-red-500 hover:bg-red-600 flex items-center justify-center text-white font-600 transition">
                <span class="mr-2">üö™</span>
                Sair
            </button>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-auto">
            <div class="p-8">
                <!-- Header -->
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800">Bem-vindo!</h2>
                    <a href="/" class="btn btn-primary">üè† Voltar para Home</a>
                </div>

                <!-- PROFILE SECTION -->
                <div id="profile" class="section active">
                    <div class="card mb-8">
                        <div class="profile-header">
                            <div class="profile-avatar" id="user-avatar">üë§</div>
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800" id="profile-name">Carregando...</h3>
                                <p class="text-gray-600" id="profile-email">email@exemplo.com</p>
                                <p class="text-sm text-gray-500 mt-2" id="profile-date">Membro desde...</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="card">
                            <p class="text-gray-600 text-sm mb-2">Total de Neg√≥cios</p>
                            <div style="font-size: 36px; font-weight: 700; background: linear-gradient(135deg, #0066FF 0%, #00B4A0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" id="count-businesses">0</div>
                        </div>
                        <div class="card">
                            <p class="text-gray-600 text-sm mb-2">Planos Ativos</p>
                            <div style="font-size: 36px; font-weight: 700; background: linear-gradient(135deg, #0066FF 0%, #00B4A0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" id="count-plans">0</div>
                        </div>
                        <div class="card">
                            <p class="text-gray-600 text-sm mb-2">Total de Avalia√ß√µes</p>
                            <div style="font-size: 36px; font-weight: 700; background: linear-gradient(135deg, #0066FF 0%, #00B4A0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" id="count-reviews">0</div>
                        </div>
                    </div>
                </div>

                <!-- MY BUSINESSES SECTION -->
                <div id="my-businesses" class="section">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Meus Neg√≥cios</h3>
                        <a href="/register-business.html" class="btn btn-primary">‚ûï Novo Neg√≥cio</a>
                    </div>

                    <div class="card">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Categoria</th>
                                    <th>Cidade</th>
                                    <th>Plano</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="businesses-table">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-500">Carregando neg√≥cios...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- MY REVIEWS SECTION -->
                <div id="my-reviews" class="section">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">Minhas Avalia√ß√µes</h3>

                    <div class="card">
                        <table>
                            <thead>
                                <tr>
                                    <th>Neg√≥cio</th>
                                    <th>Nota</th>
                                    <th>Coment√°rio</th>
                                    <th>Data</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="reviews-table">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-500">Carregando avalia√ß√µes...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- FAVORITES SECTION -->
                <div id="favorites" class="section">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">Neg√≥cios Favoritos ‚ù§Ô∏è</h3>

                    <div id="favorites-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="card text-center py-12">
                            <p class="text-gray-500">Carregando favoritos...</p>
                        </div>
                    </div>
                </div>

                <!-- SETTINGS SECTION -->
                <div id="settings" class="section">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">Configura√ß√µes da Conta</h3>

                    <div class="card max-w-2xl">
                        <h4 class="text-xl font-bold mb-6 text-gray-800">Editar Perfil</h4>
                        
                        <div class="form-group">
                            <label>Nome Completo</label>
                            <input type="text" id="settings-name" placeholder="Seu nome">
                        </div>

                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="settings-email" placeholder="Seu email" readonly>
                        </div>

                        <div class="form-group">
                            <label>Telefone</label>
                            <input type="tel" id="settings-phone" placeholder="(XX) 9XXXX-XXXX">
                        </div>

                        <div class="form-group">
                            <label>Cidade</label>
                            <select id="settings-city" style="width: 100%; padding: 10px 12px; border: 1px solid #e9ecef; border-radius: 8px;">
                                <option value="">-- Selecione --</option>
                                <option value="Quatis">Quatis</option>
                                <option value="Porto Real">Porto Real</option>
                                <option value="Resende">Resende</option>
                                <option value="Barra Mansa">Barra Mansa</option>
                                <option value="Itatiaia">Itatiaia</option>
                            </select>
                        </div>

                        <div class="flex gap-3 mt-8">
                            <button onclick="saveSettings()" class="btn btn-primary">‚úÖ Salvar Altera√ß√µes</button>
                            <button onclick="changePassword()" class="btn" style="background: #95a5a6; color: white;">üîê Mudar Senha</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://vivacidade-brasil-api.onrender.com/api';
        let token = localStorage.getItem('token');
        let userData = JSON.parse(localStorage.getItem('user') || '{}');

        // Check authentication
        window.addEventListener('load', () => {
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            loadProfileData();
        });

        function switchSection(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

            document.getElementById(sectionName).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');

            if (sectionName === 'my-businesses') loadMyBusinesses();
            else if (sectionName === 'my-reviews') loadMyReviews();
            else if (sectionName === 'favorites') loadFavorites();
            else if (sectionName === 'settings') loadSettings();
        }

        async function loadProfileData() {
            try {
                const res = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                    return;
                }

                const user = await res.json();
                userData = user;
                localStorage.setItem('user', JSON.stringify(user));

                document.getElementById('profile-name').textContent = user.name || 'Usu√°rio';
                document.getElementById('profile-email').textContent = user.email;
                document.getElementById('profile-date').textContent = `Membro desde ${new Date(user.createdAt).toLocaleDateString('pt-BR')}`;
                document.getElementById('user-avatar').textContent = user.name ? user.name.charAt(0).toUpperCase() : 'üë§';

                loadStats();
            } catch (err) {
                console.error('Erro ao carregar perfil:', err);
            }
        }

        async function loadStats() {
            try {
                const [businessesRes, reviewsRes] = await Promise.all([
                    fetch(`${API_URL}/businesses?owner=${userData._id}`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${API_URL}/admin/reviews`, { headers: { 'Authorization': `Bearer ${token}` } })
                ]);

                const businesses = await businessesRes.json();
                const reviews = await reviewsRes.json();

                const myReviews = reviews.filter(r => r.userId === userData._id);
                const myBusinesses = businesses.filter(b => b.owner === userData._id || b.owner?._id === userData._id);
                const activePlans = myBusinesses.filter(b => b.plan && b.plan !== 'free').length;
                const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');

                document.getElementById('count-businesses').textContent = Array.isArray(myBusinesses) ? myBusinesses.length : 0;
                document.getElementById('count-plans').textContent = activePlans;
                document.getElementById('count-reviews').textContent = myReviews.length;
            } catch (err) {
                console.error('Erro ao carregar stats:', err);
            }
        }

        async function loadMyBusinesses() {
            try {
                const res = await fetch(`${API_URL}/businesses`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const businesses = await res.json();
                const myBusiness = businesses.filter(b => b.owner === userData._id || b.owner?._id === userData._id);

                const tbody = document.getElementById('businesses-table');
                if (!Array.isArray(myBusiness) || myBusiness.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">Voc√™ ainda n√£o tem neg√≥cios cadastrados</td></tr>';
                    return;
                }

                const planColors = {
                    'free': 'badge-success',
                    'start': 'badge-warning',
                    'plus': 'badge-warning',
                    'elite': 'bg-purple-200 text-purple-800'
                };

                const planLabels = {
                    'free': 'üÜì Gr√°tis',
                    'start': '‚≠ê Iniciante',
                    'plus': '‚ú® Plus',
                    'elite': 'üëë Elite'
                };

                tbody.innerHTML = myBusiness.map(b => `
                    <tr>
                        <td><strong>${b.name}</strong></td>
                        <td>${b.category || '-'}</td>
                        <td>${b.city || '-'}</td>
                        <td><span class="badge ${planColors[b.plan] || 'badge-success'}">${planLabels[b.plan] || b.plan}</span></td>
                        <td style="display: flex; gap: 8px;">
                            <a href="/register-business.html?id=${b._id}" class="btn btn-edit" style="padding: 6px 12px; font-size: 12px;">‚úèÔ∏è Editar</a>
                            ${b.plan === 'free' ? `<a href="/plans.html?business=${b._id}" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;">üì¶ Upgrade</a>` : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error(err);
                document.getElementById('businesses-table').innerHTML = '<tr><td colspan="5" class="text-center py-8 text-red-500">Erro ao carregar</td></tr>';
            }
        }

        async function loadMyReviews() {
            try {
                const res = await fetch(`${API_URL}/admin/reviews`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const reviews = await res.json();
                const myReviews = reviews.filter(r => r.userId === userData._id);

                const tbody = document.getElementById('reviews-table');
                if (!Array.isArray(myReviews) || myReviews.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">Voc√™ ainda n√£o avaliou nenhum neg√≥cio</td></tr>';
                    return;
                }

                tbody.innerHTML = myReviews.map(r => `
                    <tr>
                        <td>${r.businessId || '-'}</td>
                        <td><span class="badge badge-warning">${r.rating} ‚≠ê</span></td>
                        <td>${r.comment ? r.comment.substring(0, 40) + '...' : '-'}</td>
                        <td>${new Date(r.createdAt).toLocaleDateString('pt-BR')}</td>
                        <td><button class="btn btn-danger" onclick="deleteReview('${r._id}')" style="padding: 6px 12px; font-size: 12px;">üóëÔ∏è Deletar</button></td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error(err);
                document.getElementById('reviews-table').innerHTML = '<tr><td colspan="5" class="text-center py-8 text-red-500">Erro ao carregar</td></tr>';
            }
        }

        async function loadFavorites() {
            try {
                const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
                const res = await fetch(`${API_URL}/businesses`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const businesses = await res.json();
                const favoriteBusinesses = businesses.filter(b => favorites.includes(b._id));

                const list = document.getElementById('favorites-list');
                if (!favoriteBusinesses || favoriteBusinesses.length === 0) {
                    list.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-gray-500">Nenhum favorito salvo ainda</p></div>';
                    return;
                }

                list.innerHTML = favoriteBusinesses.map(b => `
                    <div class="card">
                        <h4 class="text-lg font-bold text-gray-800 mb-2">${b.name}</h4>
                        <p class="text-sm text-gray-600 mb-2">${b.category || 'Categoria'} ‚Ä¢ ${b.city || 'Cidade'}</p>
                        <p class="text-sm text-gray-600 mb-4 line-clamp-2">${b.description || 'Sem descri√ß√£o'}</p>
                        <button onclick="removeFavorite('${b._id}')" class="btn btn-danger w-full">‚ù§Ô∏è Remover</button>
                    </div>
                `).join('');
            } catch (err) {
                console.error(err);
            }
        }

        async function loadSettings() {
            document.getElementById('settings-name').value = userData.name || '';
            document.getElementById('settings-email').value = userData.email || '';
            document.getElementById('settings-phone').value = userData.phone || '';
            document.getElementById('settings-city').value = userData.city || '';
        }

        async function saveSettings() {
            const name = document.getElementById('settings-name').value;
            const phone = document.getElementById('settings-phone').value;
            const city = document.getElementById('settings-city').value;

            if (!name) {
                alert('Preencha o nome');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/auth/update-profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name, phone, city })
                });

                if (res.ok) {
                    alert('Perfil atualizado com sucesso!');
                    loadProfileData();
                } else {
                    alert('Erro ao atualizar perfil');
                }
            } catch (err) {
                console.error(err);
                alert('Erro ao conectar');
            }
        }

        function changePassword() {
            const newPassword = prompt('Digite a nova senha:');
            if (!newPassword) return;

            const confirmPassword = prompt('Confirme a nova senha:');
            if (newPassword !== confirmPassword) {
                alert('As senhas n√£o coincidem');
                return;
            }

            alert('Funcionalidade em desenvolvimento. Contate o suporte para mudar sua senha.');
        }

        function removeFavorite(businessId) {
            let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            favorites = favorites.filter(id => id !== businessId);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            loadFavorites();
        }

        async function deleteReview(id) {
            if (!confirm('Deseja deletar essa avalia√ß√£o?')) return;

            try {
                const res = await fetch(`${API_URL}/admin/reviews/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    alert('Avalia√ß√£o deletada!');
                    loadMyReviews();
                    loadStats();
                }
            } catch (err) {
                console.error(err);
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>
